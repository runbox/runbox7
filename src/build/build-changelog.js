const exec = require('child_process').exec;
const fs = require('fs');

// starting from b74b99e all messages are fine... hopefully :)
exec('git log --pretty="%h %ct %s" --no-merges b74b99e..', (stdin, stdout, stderr) => {
    const lines = stdout.split('\n');
    const changes = [];

    for (const line of lines) {
        if (!line) {
            continue;
        }

        // don't include changelog updates in the changelog
        if (line.search(/docs\(changelog\)/) !== -1) {
            continue;
        }

        const m = line.match(/(\w+)\s(\d+)\s(\w+)\(([^)]+)\):\s(.+)/);
        if (m) {
            changes.push(m.slice(1, 6));
        } else {
            throw new Error('Invalid commit format for ' + line);
        }
    }

    let changes_file = fs.readFileSync('src/app/changelog/changes.ts').toString();
    const changes_data = `const changes = ${JSON.stringify(changes, null, 4)};\n`;
    const re = /(?<=BEGIN:AUTOGENERATED\s+)([\s\S]+?)\s+(?=\/\/ END:AUTOGENERATED)/;
    changes_file = changes_file.replace(re, changes_data);

    fs.writeFileSync('src/app/changelog/changes.ts', changes_file);
    console.log('changes.ts updated');
});
