<mat-sidenav-container class="dkim">
    <mat-sidenav mode="side" open="true"></mat-sidenav>
    <mat-sidenav-content>
        <section class="mat-typography">
            <mat-card class='dkim'>
                <mat-card-header style="display: flex; width: 100%">
                    <mat-card-title style="flex-grow: 1">
                        <h1 class='headline'>DKIM Signing of Domain Names</h1>
                        <h2 class='subheading-2'>{{domain}}</h2>
                    </mat-card-title>
                </mat-card-header>
                <p>
                DKIM (DomainKeys Identified Mail) is an email authentication method that places a digital signature (a piece of code) in the headers of your outgoing mail. This helps receiving email servers identify if the message was genuinely sent by you, the domain owner, and confirms that certain aspects of the message have been unchanged since the digital signature was added. <a href="https://help.runbox.com/dkim-signing/">More information about DKIM</a>
                </p>
                <p>
                If you have your domain name hosted by Runbox, your DNS (Domain Name System) records are also managed by us. This makes it very easy to set up DKIM signing as you just need to activate it below.
                </p>
                <p>
                If your domain is not hosted/registered via Runbox then we probably don't host your DNS records and you will need to make some changes at your domain host/DNS host as shown below.
                </p>
                <mat-divider></mat-divider>
                <div *ngIf="dkim_domains && dkim_domains.length" style="margin-top: 35px;">
                    <mat-form-field style='margin-left: 20px; width: auto;'>
                        <mat-label>View domain</mat-label>
                        <mat-select [(ngModel)]="domain" (change)="update_selected_dkim_domain()" (selectionChange)="update_selected_dkim_domain()">
                            <mat-option *ngFor="let item of dkim_domains" [value]="item.domain">{{ item.domain }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field *ngIf="keys && keys.length" style='margin-left: 40px; width: auto;'>
                        <mat-label>View settings for:</mat-label>
                        <mat-select [(ngModel)]="selected_selector" (selectionChange)="update_selected_selector()" (change)="update_selected_selector()">
                            <mat-option *ngFor="let item of keys; let i = index" [value]="item.selector">{{ item.selector }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <div style='margin-left: 40px; display: inline-block;'>
                        <button *ngIf="domain" mat-raised-button color="warn" (click)="disable()" style='margin-let: 20px;'>Disable DKIM for {{domain}}
                  <mat-progress-bar mode="indeterminate" *ngIf="is_deleting_keys"></mat-progress-bar>
</button>
                    </div>
                </div>
                <mat-divider></mat-divider>
                <mat-card *ngIf="domain && key_selected && keys && keys.length">
                    <h2 class="mat-h2" style="background: #98ADC9; padding: 20px 15px;">DKIM {{domain}} <span style='font-style: italic;'>{{selected_selector}}</span> <span *ngIf="key_selected"> (<strong>{{get_status(key_selected)}}</strong>)</span>.{{d}}</h2>
                    <h3 class="subheading-2" *ngIf="key_selected && key_selected.date_expected_to_activate" style='background: #98ADC9; padding: 0 15px 10px 15px; margin-top: -21px;'>Will become active on {{key_selected.date_expected_to_activate}}</h3>
                    <div *ngIf="key_selected" style="margin-top: 20px">
                        <mat-grid-list cols="2" rowHeight="30px" style='max-width: 800px'>
                            <mat-grid-tile><div class="grid_align_right">Hostname:</div></mat-grid-tile>
                            <mat-grid-tile><div class="grid_align_left">{{key_selected.selector_recordset_name}}</div></mat-grid-tile>

                            <mat-grid-tile *ngIf="key_selected.public_recordset_name"><div class="grid_align_right">Address:</div></mat-grid-tile>
                            <mat-grid-tile *ngIf="key_selected.public_recordset_name"><div class="grid_align_left">{{key_selected.public_recordset_name}}</div></mat-grid-tile>

                            <mat-grid-tile><div class="grid_align_right">CNAME Correct?</div></mat-grid-tile>
                            <mat-grid-tile>
                                <div class="grid_align_left">
                                    {{key_selected.is_cname_correct ? 'yes' : 'no'}}
                                </div>
                                <div *ngIf="key_selected.is_cname_hosted_by_runbox && !key_selected.is_cname_correct">
                                    <button mat-raised-button color="primary" (click)="reconfigure(key_selected)">Reconfigure *</button>
                                    <button mat-raised-button color="primary" (click)="check_cname(key_selected)">Check CNAME</button>
                                </div>
                            </mat-grid-tile>

                            <mat-grid-tile><div class="grid_align_right">Key Active?</div></mat-grid-tile>
                            <mat-grid-tile><div class="grid_align_left">{{get_status(key_selected)}}</div></mat-grid-tile>

                            <mat-grid-tile *ngIf="key_selected.date_expected_to_activate"><div class="grid_align_right">Will become active on:</div></mat-grid-tile>
                            <mat-grid-tile *ngIf="key_selected.date_expected_to_activate"><div class="grid_align_left">{{key_selected.date_expected_to_activate}}</div></mat-grid-tile>

                            <mat-grid-tile *ngIf="is_rotating && !key_selected.active"><div class="grid_align_right">Key rotating?</div></mat-grid-tile>
                            <mat-grid-tile *ngIf="is_rotating && !key_selected.active"><div class="grid_align_left">Yes</div></mat-grid-tile>

                            <mat-grid-tile *ngIf="!key_selected.is_cname_correct && key_selected.cname_check_result"><div class="grid_align_right">
                                Lastest CNAME check result:
                            </div></mat-grid-tile>
                            <mat-grid-tile *ngIf="!key_selected.is_cname_correct && key_selected.cname_check_result"><div class="grid_align_left">
                                {{key_selected.cname_check_result}}
                            </div></mat-grid-tile>

                            <mat-grid-tile *ngIf="!key_selected.is_cname_correct && key_selected.cname_check_result"><div class="grid_align_right">
                                Lastest <strong>expected</strong> CNAME result:
                            </div></mat-grid-tile>
                            <mat-grid-tile *ngIf="!key_selected.is_cname_correct && key_selected.cname_check_result"><div class="grid_align_left">
                                {{key_selected.cname_check_expected}}
                            </div></mat-grid-tile>

                        </mat-grid-list>

                        <h2 class='mat-h2' style="margin-top: 30px; background: #98ADC9; padding: 20px 15px;">Tips to manually configure the DKIM keys:</h2>
                        <p>
                        Use the following to manually configure DKIM in your DNS:
                        </p>
                        <pre class="terminal">
    {{key_selected.selector_recordset_name}} 3600 IN CNAME {{key_selected.public_recordset_name}}
                        </pre>
                        <p>
                        To check the CNAME records, you can use the "dig" command such as in this example:
                        </p>
                        <pre class="terminal">
    dig -t CNAME {{key_selected.selector_recordset_name}}
                        </pre>
                        <p>
                        ...and the expected response would be:
                        </p>
                        <pre class="terminal">
    ;; ANSWER SECTION:
    {{key_selected.selector_recordset_name}} 3600 IN CNAME {{key_selected.public_recordset_name}}
                        </pre>
                        To check the public key, do:
                        <pre class="terminal">
    dig -t TXT {{key_selected.public_recordset_name}}
                        </pre>
                        ...and the expected response would be something like:
                        <pre class="terminal">
    ;; ANSWER SECTION:
    {{key_selected.public_recordset_name}}. 300 IN TXT "v=DKIM1; k=rs
    a; p=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    xx" "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

                        </pre>
                        <span >* It might take a few minutes for the system to be able to check recent changes.</span>
                        <span *ngIf="is_rotating && !key_selected.active">
                            This key is under rotation state. This means it has been published however this key is not in use yet. Rotation has initialized on {{key_selected.date_rotation_initiated}} and is expected to take 7 days to become active.
                        </span>

                        <mat-divider></mat-divider>
                        <br />
                        <div *ngIf="!domain">
                            Please select a domain to continue.
                        </div>

                    </div>
                </mat-card>                    
                <div *ngIf="!dkim_domains || !dkim_domains.length" style='margin-top: 35px'>
                  <div *ngIf="domain && !keys.length && !is_creating_keys">
                      No keys found for {{domain}}
                      <button mat-raised-button color="primary" (click)="create_keys()" style="margin-left: 20px">Create keys for {{domain}}</button>
                  </div>
                  <mat-progress-bar mode="indeterminate" *ngIf="is_creating_keys"></mat-progress-bar>
                </div>
            </mat-card>
        </section>
    </mat-sidenav-content>
</mat-sidenav-container>

